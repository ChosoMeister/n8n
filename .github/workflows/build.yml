name: Build and Push n8n Enterprise Docker Image

on:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: chosomeister/n8n
  IMAGE_TAG: enterprise

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4

    - name: Clone n8n repository
      run: |
        git clone --depth=1 https://github.com/n8n-io/n8n.git n8n-source
        cd n8n-source
        
        # Fetch only the latest release tag
        git fetch --depth=1 origin +refs/tags/*:refs/tags/*

        # Get latest stable release
        releases_json=$(curl -s --retry 3 --retry-delay 5 https://api.github.com/repos/n8n-io/n8n/releases)
        if [ $? -ne 0 ]; then
          echo "Failed to fetch releases, using default branch"
        else
          latest_stable_tag=$(echo "$releases_json" | jq -r '.[] | select(.prerelease == false) | .tag_name' | head -n 1)
          if [ -n "$latest_stable_tag" ] && [ "$latest_stable_tag" != "null" ]; then
            echo "Checking out latest stable tag: $latest_stable_tag"
            git fetch --depth=1 origin tag "$latest_stable_tag"
            git checkout "$latest_stable_tag"
          else
            echo "No stable release found, using default branch"
          fi
        fi

        n8n_commit_hash=$(git rev-parse HEAD)
        n8n_version=$(node -p "require('./packages/cli/package.json').version" 2>/dev/null || echo "unknown")
        echo "Cloned n8n repository successfully"
        echo "Current commit: $n8n_commit_hash"
        echo "n8n version: $n8n_version"
        echo "N8N_COMMIT_HASH=$n8n_commit_hash" >> $GITHUB_ENV
        echo "N8N_VERSION=$n8n_version" >> $GITHUB_ENV

    - name: Read version requirements from n8n package.json
      id: version-requirements
      run: |
        cd n8n-source
        
        # Read Node.js version requirement
        node_version=$(node -p "
          const pkg = require('./package.json');
          const nodeEngine = pkg.engines?.node;
          if (nodeEngine) {
            // Extract version number from patterns like '>=22.16', '>=22.16.0', '^22.16'
            const match = nodeEngine.match(/(\d+\.\d+(?:\.\d+)?)/);
            console.log(match ? match[1] : '22');
          } else {
            console.log('22');
          }
        " 2>/dev/null || echo "22")
        
        # Read pnpm version requirement
        pnpm_version=$(node -p "
          const pkg = require('./package.json');
          // First try packageManager field
          const packageManager = pkg.packageManager;
          if (packageManager && packageManager.includes('pnpm@')) {
            console.log(packageManager.split('@')[1]);
          } else if (pkg.engines?.pnpm) {
            // Extract version from engines.pnpm like '>=10.16.1'
            const match = pkg.engines.pnpm.match(/(\d+\.\d+\.\d+)/);
            console.log(match ? match[1] : '10.16.1');
          } else {
            console.log('10.16.1');
          }
        " 2>/dev/null || echo "10.16.1")
        
        echo "Detected Node.js version requirement: $node_version"
        echo "Detected pnpm version requirement: $pnpm_version"
        
        echo "NODE_VERSION=$node_version" >> $GITHUB_ENV
        echo "PNPM_VERSION=$pnpm_version" >> $GITHUB_ENV

    - name: Copy bypass script to n8n repository
      run: |
        if [ -f "bypass.sh" ]; then
          cp bypass.sh n8n-source/
          echo "bypass.sh copied to n8n-source directory"
        else
          echo "::warning::bypass.sh not found in current repository"
        fi

    - name: Setup Node.js with detected version
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Install pnpm with detected version
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}

    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

    - name: Setup pnpm cache
      uses: actions/cache@v4
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('n8n-source/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: Free up disk space
      run: |
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo apt-get clean
        docker system prune -af

    - name: Install dependencies
      run: |
        cd n8n-source
        pnpm install --frozen-lockfile --prefer-offline
      timeout-minutes: 30

    - name: Run bypass script
      run: |
        cd n8n-source
        if [ -f "bypass.sh" ]; then
          chmod +x bypass.sh
          if ./bypass.sh --auto; then
            echo "bypass.sh executed successfully with --auto mode"
          else
            echo "::error::bypass.sh execution failed"
            exit 1
          fi
        else
          echo "::warning::bypass.sh not found in n8n repository, skipping..."
        fi

    - name: Build n8n with memory optimization
      run: |
        cd n8n-source
        export NODE_OPTIONS="--max_old_space_size=7168"
        export NODE_ENV=production
        
        echo "Starting n8n build process..."
        echo "Using Node.js version: $(node --version)"
        echo "Using pnpm version: $(pnpm --version)"
        echo "Available memory:"
        free -h
        
        # Build with retry logic
        for i in {1..2}; do
          if pnpm run build; then
            echo "Build completed successfully"
            break
          else
            echo "::warning::Build attempt $i failed, retrying..."
            if [ $i -eq 2 ]; then
              echo "::error::Build failed after 2 attempts"
              exit 1
            fi
            sleep 30
          fi
        done
      timeout-minutes: 60

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build Docker image
      run: |
        cd n8n-source
        echo "Building Docker image..."
        pnpm run build:docker
        echo "Docker image built successfully"
      timeout-minutes: 30

    - name: Tag and push Docker image
      run: |
        cd n8n-source
        
        # Get the image with better error handling
        IMAGE_NAME_LOCAL=$(docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.ID}}" | grep -E "^n8n[[:space:]]" | head -1 | awk '{print $1":"$2}')
        
        if [ -z "$IMAGE_NAME_LOCAL" ]; then
          echo "::error::Could not find built n8n Docker image"
          echo "Available images:"
          docker images
          exit 1
        fi
        
        echo "Found Docker image: $IMAGE_NAME_LOCAL"
        echo "N8N commit hash: ${{ env.N8N_COMMIT_HASH }}"
        echo "N8N version: ${{ env.N8N_VERSION }}"
        
        # Define all tags
        TAGS=(
          "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:n8n-${{ env.N8N_COMMIT_HASH }}"
        )
        
        # Add version tag if available
        if [ "${{ env.N8N_VERSION }}" != "unknown" ]; then
          TAGS+=("${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:v${{ env.N8N_VERSION }}")
        fi
        
        # Tag all images
        for tag in "${TAGS[@]}"; do
          echo "Tagging: $tag"
          docker tag "$IMAGE_NAME_LOCAL" "$tag"
        done
        
        # Push all tags with retry logic
        for tag in "${TAGS[@]}"; do
          echo "Pushing: $tag"
          for i in {1..3}; do
            if docker push "$tag"; then
              echo "Successfully pushed $tag"
              break
            else
              echo "::warning::Failed to push $tag on attempt $i/3"
              if [ $i -eq 3 ]; then
                echo "::error::Failed to push $tag after 3 attempts"
                exit 1
              fi
              sleep 10
            fi
          done
        done
        
        echo "Successfully pushed all Docker image tags to GHCR"
      timeout-minutes: 30

    - name: Generate build summary
      if: always()
      run: |
        echo "## Build Summary ðŸ“Š" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| n8n Version | \`${{ env.N8N_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| n8n Commit | \`${{ env.N8N_COMMIT_HASH }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Node.js Version | \`${{ env.NODE_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| pnpm Version | \`${{ env.PNPM_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Registry | \`${{ env.REGISTRY }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Image | \`${{ env.IMAGE_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ env.N8N_VERSION }}" != "unknown" ]; then
          echo "| Available Tags | \`enterprise\`, \`latest\`, \`v${{ env.N8N_VERSION }}\`, \`${{ github.sha }}\`, \`n8n-${{ env.N8N_COMMIT_HASH }}\` |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Available Tags | \`enterprise\`, \`latest\`, \`${{ github.sha }}\`, \`n8n-${{ env.N8N_COMMIT_HASH }}\` |" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Clean up
      if: always()
      run: |
        docker system prune -af --volumes
        if [ -d "${{ env.STORE_PATH }}" ]; then
          du -sh "${{ env.STORE_PATH }}" || true
        fi
