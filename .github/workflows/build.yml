name: Build and Push n8n Enterprise Docker Image

on:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: chosomeister/n8n
  IMAGE_TAG: enterprise

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4

    - name: Clone n8n repository
      run: |
        git clone --depth=1 https://github.com/n8n-io/n8n.git n8n-source
        cd n8n-source
        
        # Fetch tags for release detection
        git fetch --depth=1 origin +refs/tags/*:refs/tags/*

        # Get latest stable release with proper error handling
        releases_json=$(curl -s --retry 3 --retry-delay 5 https://api.github.com/repos/n8n-io/n8n/releases)
        if [ $? -ne 0 ]; then
          echo "Failed to fetch releases, using default branch"
        else
          latest_stable_tag=$(echo "$releases_json" | jq -r '.[] | select(.prerelease == false) | .tag_name' | head -n 1)
          if [ -n "$latest_stable_tag" ] && [ "$latest_stable_tag" != "null" ]; then
            echo "Checking out latest stable tag: $latest_stable_tag"
            git fetch --depth=1 origin tag "$latest_stable_tag"
            git checkout "$latest_stable_tag"
          else
            echo "No stable release found, using default branch"
          fi
        fi

        n8n_commit_hash=$(git rev-parse HEAD)
        n8n_version=$(node -p "require('./packages/cli/package.json').version" 2>/dev/null || echo "unknown")
        echo "Cloned n8n repository successfully"
        echo "Current commit: $n8n_commit_hash"
        echo "n8n version: $n8n_version"
        echo "N8N_COMMIT_HASH=$n8n_commit_hash" >> $GITHUB_ENV
        echo "N8N_VERSION=$n8n_version" >> $GITHUB_ENV

    - name: Copy bypass script to n8n repository
      run: |
        if [ -f "bypass.sh" ]; then
          cp bypass.sh n8n-source/
          echo "bypass.sh copied to n8n-source directory"
        else
          echo "::warning::bypass.sh not found in current repository"
        fi

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        check-latest: true

    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest

    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

    - name: Setup pnpm cache
      uses: actions/cache@v4
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('n8n-source/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: Install dependencies
      run: |
        cd n8n-source
        pnpm install --frozen-lockfile --prefer-offline

    - name: Run bypass script
      run: |
        cd n8n-source
        if [ -f "bypass.sh" ]; then
          chmod +x bypass.sh
          if ./bypass.sh --auto; then
            echo "bypass.sh executed successfully with --auto mode"
          else
            echo "::error::bypass.sh execution failed"
            exit 1
          fi
        else
          echo "::warning::bypass.sh not found in n8n repository, skipping..."
        fi

    - name: Build n8n
      run: |
        cd n8n-source
        pnpm run build

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=raw,value=${{ env.IMAGE_TAG }}
          type=raw,value=latest,enable={{is_default_branch}}
          type=sha,prefix={{branch}}-
          type=raw,value=v${{ env.N8N_VERSION }},enable=${{ env.N8N_VERSION != 'unknown' }}

    - name: Build Docker image
      run: |
        cd n8n-source
        pnpm run build:docker

    - name: Tag and push Docker image
      run: |
        cd n8n-source
        
        # Get the image with better error handling
        IMAGE_NAME_LOCAL=$(docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.ID}}" | grep -E "^n8n[[:space:]]" | head -1 | awk '{print $1":"$2}')
        
        if [ -z "$IMAGE_NAME_LOCAL" ]; then
          echo "::error::Could not find built n8n Docker image"
          echo "Available images:"
          docker images
          exit 1
        fi
        
        echo "Found Docker image: $IMAGE_NAME_LOCAL"
        echo "N8N commit hash: ${{ env.N8N_COMMIT_HASH }}"
        echo "N8N version: ${{ env.N8N_VERSION }}"
        
        # Define all tags
        TAGS=(
          "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:n8n-${{ env.N8N_COMMIT_HASH }}"
        )
        
        # Add version tag if available
        if [ "${{ env.N8N_VERSION }}" != "unknown" ]; then
          TAGS+=("${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:v${{ env.N8N_VERSION }}")
        fi
        
        # Tag all images
        for tag in "${TAGS[@]}"; do
          echo "Tagging: $tag"
          docker tag "$IMAGE_NAME_LOCAL" "$tag"
        done
        
        # Push all tags with retry logic
        for tag in "${TAGS[@]}"; do
          echo "Pushing: $tag"
          if ! docker push "$tag"; then
            echo "::warning::Failed to push $tag on first attempt, retrying..."
            sleep 5
            docker push "$tag"
          fi
        done
        
        echo "Successfully pushed all Docker image tags to GHCR"

    - name: Generate build summary
      if: always()
      run: |
        echo "## Build Summary ðŸ“Š" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| n8n Version | \`${{ env.N8N_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| n8n Commit | \`${{ env.N8N_COMMIT_HASH }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Registry | \`${{ env.REGISTRY }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Image | \`${{ env.IMAGE_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Tags | \`enterprise\`, \`latest\`, \`${{ github.sha }}\`, \`n8n-${{ env.N8N_COMMIT_HASH }}\`" >> $GITHUB_STEP_SUMMARY
        if [ "${{ env.N8N_VERSION }}" != "unknown" ]; then
          echo ", \`v${{ env.N8N_VERSION }}\`" >> $GITHUB_STEP_SUMMARY
        fi
        echo " |" >> $GITHUB_STEP_SUMMARY

    - name: Clean up
      if: always()
      run: |
        # More comprehensive cleanup
        docker system prune -af --volumes
        # Clean pnpm cache if it gets too large
        if [ -d "${{ env.STORE_PATH }}" ]; then
          du -sh "${{ env.STORE_PATH }}" || true
        fi
