name: Build and Push n8n Enterprise Docker Image

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1'  # Every Monday at 6:00 AM UTC

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: chosomeister/n8n
  IMAGE_TAG: enterprise
  NODE_OPTIONS: '--max-old-space-size=7168'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4

    - name: Check if new version available
      id: version_check
      run: |
        echo "Checking for new n8n version..."
        
        # Get latest stable n8n release
        releases_json=$(curl -s --retry 3 --retry-delay 5 https://api.github.com/repos/n8n-io/n8n/releases)
        LATEST_N8N_VERSION=$(echo "$releases_json" | jq -r '.[] | select(.prerelease == false) | .tag_name' | head -n 1 | sed 's/^n8n@//')
        
        if [ -z "$LATEST_N8N_VERSION" ] || [ "$LATEST_N8N_VERSION" == "null" ]; then
          echo "::warning::Could not determine latest n8n version, proceeding with build"
          echo "SHOULD_BUILD=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "Latest n8n version: $LATEST_N8N_VERSION"
        
        # Check if this version already exists in GHCR
        GHCR_TAG="v${LATEST_N8N_VERSION}"
        echo "Checking if ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${GHCR_TAG} exists..."
        
        # Try to get manifest (will fail if image doesn't exist)
        if docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${GHCR_TAG} > /dev/null 2>&1; then
          echo "::notice::Version ${GHCR_TAG} already exists in registry"
          
          # For scheduled runs, skip if version exists
          # For manual runs (workflow_dispatch), always build
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "Scheduled run: Skipping build as version already exists"
            echo "SHOULD_BUILD=false" >> $GITHUB_OUTPUT
          else
            echo "Manual run: Building anyway despite version existing"
            echo "SHOULD_BUILD=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "Version ${GHCR_TAG} not found in registry, proceeding with build"
          echo "SHOULD_BUILD=true" >> $GITHUB_OUTPUT
        fi
        echo "LATEST_N8N_VERSION=$LATEST_N8N_VERSION" >> $GITHUB_ENV

    - name: Clone n8n repository
      if: steps.version_check.outputs.SHOULD_BUILD == 'true'
      run: |
        # Get latest stable tag first
        echo "Fetching latest stable release tag..."
        releases_json=$(curl -s --retry 3 --retry-delay 5 https://api.github.com/repos/n8n-io/n8n/releases)
        latest_stable_tag=$(echo "$releases_json" | jq -r '.[] | select(.prerelease == false) | .tag_name' | head -n 1)
        
        if [ -n "$latest_stable_tag" ] && [ "$latest_stable_tag" != "null" ]; then
          echo "Cloning n8n at tag: $latest_stable_tag"
          git clone --depth=1 --branch "$latest_stable_tag" https://github.com/n8n-io/n8n.git n8n-source
        else
          echo "No stable release found, cloning default branch"
          git clone --depth=1 https://github.com/n8n-io/n8n.git n8n-source
        fi
        
        cd n8n-source
        n8n_commit_hash=$(git rev-parse HEAD)
        n8n_version=$(node -p "require('./packages/cli/package.json').version" 2>/dev/null || echo "unknown")
        echo "Cloned n8n repository successfully"
        echo "Current commit: $n8n_commit_hash"
        echo "n8n version: $n8n_version"
        echo "N8N_COMMIT_HASH=$n8n_commit_hash" >> $GITHUB_ENV
        echo "N8N_VERSION=$n8n_version" >> $GITHUB_ENV

    - name: Read version requirements from n8n package.json
      if: steps.version_check.outputs.SHOULD_BUILD == 'true'
      run: |
        cd n8n-source

        if ! command -v jq >/dev/null 2>&1; then
          echo "::error::jq is required to read package.json"
          exit 1
        fi

        NODE_VERSION_RAW=$(jq -r '.engines.node // "22"' package.json)
        NODE_VERSION_CLEAN=$(echo "$NODE_VERSION_RAW" | sed -E 's/[^0-9.]+//g')
        if [ -z "$NODE_VERSION_CLEAN" ]; then
          NODE_VERSION_CLEAN="22"
        fi

        NODE_VERSION_MAJOR=$(echo "$NODE_VERSION_CLEAN" | cut -d'.' -f1)
        if [ -z "$NODE_VERSION_MAJOR" ]; then
          NODE_VERSION_MAJOR="$NODE_VERSION_CLEAN"
        fi

        PNPM_VERSION=$(jq -r '.packageManager // empty' package.json | sed -n 's/.*pnpm@\([0-9.]*\).*/\1/p')
        if [ -z "$PNPM_VERSION" ]; then
          PNPM_VERSION=$(jq -r '.engines.pnpm // ""' package.json | sed -n 's/.*\([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p')
        fi
        if [ -z "$PNPM_VERSION" ]; then
          PNPM_VERSION="10.16.1"
        fi

        echo "Detected Node.js requirement: $NODE_VERSION_RAW (clean: $NODE_VERSION_CLEAN, major: $NODE_VERSION_MAJOR)"
        echo "NODE_VERSION=$NODE_VERSION_MAJOR" >> $GITHUB_ENV
        echo "NODE_VERSION_FULL=$NODE_VERSION_CLEAN" >> $GITHUB_ENV
        echo "PNPM_VERSION=$PNPM_VERSION" >> $GITHUB_ENV

    - name: Copy bypass script to n8n repository
      if: steps.version_check.outputs.SHOULD_BUILD == 'true'
      run: |
        if [ -f "bypass.sh" ]; then
          cp bypass.sh n8n-source/
          echo "bypass.sh copied to n8n-source directory"
        else
          echo "::warning::bypass.sh not found in current repository"
        fi

    - name: Setup Node.js with detected version
      if: steps.version_check.outputs.SHOULD_BUILD == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION_FULL }}

    - name: Install pnpm with detected version
      if: steps.version_check.outputs.SHOULD_BUILD == 'true'
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}

    - name: Get pnpm store directory
      if: steps.version_check.outputs.SHOULD_BUILD == 'true'
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

    - name: Setup pnpm cache
      if: steps.version_check.outputs.SHOULD_BUILD == 'true'
      uses: actions/cache@v4
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('n8n-source/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: Install dependencies (pnpm install --frozen-lockfile)
      if: steps.version_check.outputs.SHOULD_BUILD == 'true'
      run: |
        cd n8n-source
        pnpm install --frozen-lockfile
      timeout-minutes: 30

    - name: Free up disk space
      if: steps.version_check.outputs.SHOULD_BUILD == 'true'
      run: |
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo apt-get clean
        docker system prune -af

    - name: Run bypass script
      if: steps.version_check.outputs.SHOULD_BUILD == 'true'
      run: |
        cd n8n-source
        if [ -f "bypass.sh" ]; then
          chmod +x bypass.sh
          if ./bypass.sh --auto; then
            echo "bypass.sh executed successfully with --auto mode"
          else
            echo "::error::bypass.sh execution failed"
            exit 1
          fi
        else
          echo "::warning::bypass.sh not found in n8n repository, skipping..."
        fi

    - name: Build n8n artifacts (matches upstream workflow)
      if: steps.version_check.outputs.SHOULD_BUILD == 'true'
      run: |
        cd n8n-source

        export NODE_ENV=production

        echo "Starting official n8n build (pnpm build:n8n)..."
        echo "Using Node.js version: $(node --version)"
        echo "Using pnpm version: $(pnpm --version)"

        for attempt in 1 2; do
          if pnpm build:n8n; then
            echo "n8n build completed successfully"
            break
          fi

          if [ "$attempt" -eq 2 ]; then
            echo "::error::pnpm build:n8n failed after 2 attempts"
            exit 1
          fi

          echo "::warning::pnpm build:n8n failed on attempt $attempt, retrying..."
          sleep 30
        done
      timeout-minutes: 90

    - name: Set up Docker Buildx
      if: steps.version_check.outputs.SHOULD_BUILD == 'true'
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      if: steps.version_check.outputs.SHOULD_BUILD == 'true'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build Docker image with caching
      if: steps.version_check.outputs.SHOULD_BUILD == 'true'
      uses: docker/build-push-action@v5
      with:
        context: n8n-source
        file: n8n-source/docker/images/n8n/Dockerfile
        push: false
        load: true
        tags: n8n:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          NODE_VERSION=${{ env.NODE_VERSION }}
          N8N_VERSION=${{ env.N8N_VERSION }}
          N8N_RELEASE_TYPE=stable

    - name: Verify Docker image was built
      if: steps.version_check.outputs.SHOULD_BUILD == 'true'
      run: |
        echo "Built Docker images:"
        docker images n8n:latest
        
        if [ "$(docker images -q n8n:latest)" = "" ]; then
          echo "::error::Docker image was not built successfully"
          exit 1
        fi
        
        echo "Docker image built successfully with tag: n8n:latest"

    - name: Health check Docker image
      if: steps.version_check.outputs.SHOULD_BUILD == 'true'
      run: |
        echo "Starting n8n container for health check..."
        docker run -d --name n8n-health-test -p 5678:5678 \
          -e N8N_DIAGNOSTICS_ENABLED=false \
          -e N8N_SECURE_COOKIE=false \
          n8n:latest
        
        echo "Waiting for n8n to start (max 60 seconds)..."
        for i in {1..12}; do
          if curl -sf http://localhost:5678/healthz > /dev/null 2>&1; then
            echo "âœ… Health check passed!"
            docker stop n8n-health-test && docker rm n8n-health-test
            exit 0
          fi
          echo "Attempt $i/12: Waiting 5 more seconds..."
          sleep 5
        done
        
        echo "::error::Health check failed after 60 seconds"
        echo "Container logs:"
        docker logs n8n-health-test
        docker stop n8n-health-test && docker rm n8n-health-test
        exit 1
      timeout-minutes: 5

    - name: Tag and push Docker image
      if: steps.version_check.outputs.SHOULD_BUILD == 'true'
      run: |
        cd n8n-source
        
        IMAGE_NAME_LOCAL="n8n:latest"
        
        if [ "$(docker images -q $IMAGE_NAME_LOCAL)" = "" ]; then
          echo "::error::Could not find built n8n Docker image"
          echo "Available images:"
          docker images
          exit 1
        fi
        
        echo "Found Docker image: $IMAGE_NAME_LOCAL"
        echo "N8N commit hash: ${{ env.N8N_COMMIT_HASH }}"
        echo "N8N version: ${{ env.N8N_VERSION }}"
        
        # Define all tags
        TAGS=(
          "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:n8n-${{ env.N8N_COMMIT_HASH }}"
        )
        
        if [ "${{ env.N8N_VERSION }}" != "unknown" ]; then
          TAGS+=("${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:v${{ env.N8N_VERSION }}")
        fi
        
        # Tag all images
        for tag in "${TAGS[@]}"; do
          echo "Tagging: $tag"
          docker tag "$IMAGE_NAME_LOCAL" "$tag"
        done
        
        # Push all tags with retry logic
        for tag in "${TAGS[@]}"; do
          echo "Pushing: $tag"
          for i in {1..3}; do
            if docker push "$tag"; then
              echo "Successfully pushed $tag"
              break
            else
              echo "::warning::Failed to push $tag on attempt $i/3"
              if [ $i -eq 3 ]; then
                echo "::error::Failed to push $tag after 3 attempts"
                exit 1
              fi
              sleep 10
            fi
          done
        done
        
        echo "Successfully pushed all Docker image tags to GHCR"
      timeout-minutes: 30

    - name: Generate build summary
      if: always() && steps.version_check.outputs.SHOULD_BUILD == 'true'
      run: |
        echo "## Build Summary ðŸ“Š" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| n8n Version | \`${{ env.N8N_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| n8n Commit | \`${{ env.N8N_COMMIT_HASH }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Node.js Version | \`${{ env.NODE_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| pnpm Version | \`${{ env.PNPM_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Registry | \`${{ env.REGISTRY }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Image | \`${{ env.IMAGE_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ env.N8N_VERSION }}" != "unknown" ]; then
          echo "| Available Tags | \`enterprise\`, \`latest\`, \`v${{ env.N8N_VERSION }}\`, \`${{ github.sha }}\`, \`n8n-${{ env.N8N_COMMIT_HASH }}\` |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Available Tags | \`enterprise\`, \`latest\`, \`${{ github.sha }}\`, \`n8n-${{ env.N8N_COMMIT_HASH }}\` |" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Generate skip summary
      if: steps.version_check.outputs.SHOULD_BUILD == 'false'
      run: |
        echo "## â­ï¸ Build Skipped" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Reason:** Version \`v${{ env.LATEST_N8N_VERSION }}\` already exists in registry." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "This was a scheduled build that detected no new n8n version." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "To force a rebuild, trigger the workflow manually." >> $GITHUB_STEP_SUMMARY

    - name: Clean up
      if: always()
      run: |
        docker system prune -af --volumes
        if [ -d "${{ env.STORE_PATH }}" ]; then
          du -sh "${{ env.STORE_PATH }}" || true
        fi

    - name: Notify on failure
      if: failure()
      run: |
        echo "## âŒ Build Failed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The n8n Enterprise Docker image build has failed." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow Run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Please check the logs for more details." >> $GITHUB_STEP_SUMMARY
